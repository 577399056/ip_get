name: Update KV JSON

on:
  schedule:
    # 每天UTC时间0点运行（北京时间早上8点）
    - cron: '0 0 * * *'
  # 允许手动触发
  workflow_dispatch:
    inputs:
      reason:
        description: '手动触发原因'
        required: false
        default: '手动执行更新'

jobs:
  update-kv:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出仓库
      uses: actions/checkout@v4
      with:
        # 获取完整历史记录，以便可以比较旧版本
        fetch-depth: 0

    - name: 设置Node.js环境
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: 获取并处理JSON数据
      run: |
        # 创建处理脚本
        cat > process_json.js << 'EOF'
        const fs = require('fs');
        const https = require('https');
        const path = require('path');

        // 获取远程JSON数据
        function fetchRemoteJson(url) {
          return new Promise((resolve, reject) => {
            https.get(url, (response) => {
              let data = '';
              
              response.on('data', (chunk) => {
                data += chunk;
              });
              
              response.on('end', () => {
                try {
                  resolve(JSON.parse(data));
                } catch (error) {
                  reject(new Error('解析JSON失败: ' + error.message));
                }
              });
            }).on('error', (error) => {
              reject(new Error('获取数据失败: ' + error.message));
            });
          });
        }

        // 过滤掉group为premium的数据
        function filterPremium(data) {
          // 根据数据格式处理，假设数据可能是数组或对象
          if (Array.isArray(data)) {
            return data.filter(item => item.group !== 'premium');
          } else if (data.items && Array.isArray(data.items)) {
            // 如果数据是对象且有items数组
            const filteredItems = data.items.filter(item => item.group !== 'premium');
            return { ...data, items: filteredItems };
          } else if (typeof data === 'object') {
            // 如果是对象但没有特定结构，尝试删除group为premium的属性
            const result = {};
            for (const [key, value] of Object.entries(data)) {
              if (!value || value.group !== 'premium') {
                result[key] = value;
              }
            }
            return result;
          }
          return data;
        }

        async function main() {
          try {
            const remoteUrl = 'https://raw.githubusercontent.com/rapier15sapper/ew/refs/heads/main/test.json';
            console.log('正在获取远程数据...');
            
            const remoteData = await fetchRemoteJson(remoteUrl);
            console.log('获取远程数据成功');
            
            // 过滤数据
            const filteredData = filterPremium(remoteData);
            console.log('过滤掉group为premium的数据');
            
            // 检查本地kv.json是否存在
            const kvPath = path.join(process.cwd(), 'kv.json');
            let localData = null;
            let hasChanges = true;
            
            if (fs.existsSync(kvPath)) {
              console.log('发现已存在的kv.json文件');
              try {
                const kvContent = fs.readFileSync(kvPath, 'utf8');
                localData = JSON.parse(kvContent);
                
                // 比较数据是否有变化
                if (JSON.stringify(filteredData) === JSON.stringify(localData)) {
                  console.log('数据无变化，跳过写入');
                  hasChanges = false;
                } else {
                  console.log('发现数据变化，准备更新');
                }
              } catch (error) {
                console.log('读取或解析现有kv.json失败:', error.message);
                console.log('将创建新的kv.json文件');
              }
            } else {
              console.log('未发现kv.json文件，将创建新文件');
            }
            
            if (hasChanges) {
              // 写入处理后的数据
              fs.writeFileSync(kvPath, JSON.stringify(filteredData, null, 2));
              console.log('kv.json文件已更新');
              
              // 如果需要，可以创建一个change.txt文件记录更新时间
              const timestamp = new Date().toISOString();
              fs.writeFileSync('last_update.txt', `最后更新时间: ${timestamp}\n原始数据: ${remoteUrl}`);
            }
            
            // 输出数据统计
            const originalCount = Array.isArray(remoteData) ? remoteData.length : Object.keys(remoteData).length;
            const filteredCount = Array.isArray(filteredData) ? filteredData.length : Object.keys(filteredData).length;
            console.log(`数据统计: 原始 ${originalCount} 条，过滤后 ${filteredCount} 条，移除了 ${originalCount - filteredCount} 条`);
            
          } catch (error) {
            console.error('处理过程中发生错误:', error.message);
            process.exit(1);
          }
        }

        main();
        EOF

        # 运行处理脚本
        node process_json.js

    - name: 检查文件变化
      id: git-check
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # 检查是否有文件变化
        if git diff --quiet HEAD; then
          echo "没有文件变化"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "检测到文件变化"
          git status
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: 提交和推送更改
      if: steps.git-check.outputs.has_changes == 'true'
      run: |
        git add kv.json last_update.txt 2>/dev/null || true
        git commit -m "更新kv.json数据 [skip ci]"
        git push
